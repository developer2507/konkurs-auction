# Спецификация механики аукциона

## Анализ Telegram Gift Auctions

На основе исследования публичных источников, Telegram Gift Auctions работают следующим образом:

### Основные принципы

1. **Многораундовая система**
   - Аукцион состоит из нескольких раундов
   - В каждом раунде часть участников выигрывает
   - Остальные продолжают в следующих раундах

2. **Раунды и тайминги**
   - Первый раунд длится дольше (например, час или несколько часов)
   - Последующие раунды короче (например, 5 минут)
   - Это позволяет участникам постепенно "отсеиваться"

3. **Определение победителей**
   - В каждом раунде выбираются N участников с наивысшими ставками
   - Победители получают товар и выходят из аукциона
   - Проигравшие получают возврат средств и могут участвовать дальше

4. **Anti-sniping механизм**
   - Если ставка приходит в последние секунды раунда, время продлевается
   - Это предотвращает "снайперские" ставки в последнюю секунду
   - Участники имеют время ответить

5. **Финансовые операции**
   - Средства блокируются при размещении ставки
   - При перебитии ставки предыдущему лидеру возвращаются средства
   - При выигрыше средства списываются окончательно
   - При проигрыше средства возвращаются

## Принятые допущения

### 1. Структура раундов

**Допущение:** Раунды последовательные, без перекрытий
- **Почему:** Упрощает логику и гарантирует, что все участники видят одинаковое состояние
- **Альтернатива:** Параллельные раунды (более сложно, но возможно)

### 2. Возврат средств проигравшим

**Допущение:** Средства возвращаются сразу после завершения раунда
- **Почему:** Участники могут использовать средства для следующего раунда
- **Альтернатива:** Возврат только после всех раундов (меньше операций, но хуже UX)

### 3. Минимальный шаг ставки

**Допущение:** Фиксированный минимальный шаг для всего аукциона
- **Почему:** Простота реализации
- **Альтернатива:** Динамический шаг (например, процент от текущей ставки)

### 4. Количество победителей

**Допущение:** Фиксированное количество победителей в каждом раунде
- **Почему:** Соответствует описанию Telegram-аукционов
- **Альтернатива:** Динамическое (например, топ 10% участников)

### 5. Комиссия платформы

**Допущение:** 10% комиссия с каждой выигрышной ставки
- **Почему:** Стандартная практика для платформ
- **Альтернатива:** Фиксированная комиссия или другая модель

### 6. Anti-sniping продление

**Допущение:** Продлеваем на фиксированное количество секунд
- **Почему:** Предсказуемое поведение для участников
- **Альтернатива:** Экспоненциальное продление или процентное

### 7. Обработка ничьих

**Допущение:** При равных ставках побеждает тот, кто сделал ставку раньше
- **Почему:** Справедливо и детерминировано
- **Альтернатива:** Случайный выбор или все равные ставки

### 8. Переход между раундами

**Допущение:** Цена сбрасывается к стартовой в новом раунде
- **Почему:** Все участники начинают "с нуля"
- **Альтернатива:** Текущая цена продолжается (но тогда нужны новые правила)

## Нерешённые вопросы

### 1. Поведение при сбое сервера во время завершения раунда

**Решение:** Используем MongoDB транзакции и BullMQ с retry
- При сбое транзакция откатывается
- Задача в очереди повторяется
- Гарантируется консистентность

### 2. Поведение при одновременных ставках на последней секунде

**Решение:** Distributed lock + проверка времени внутри транзакции
- Только одна ставка обрабатывается одновременно
- Время проверяется атомарно
- Anti-sniping применяется корректно

### 3. Что делать, если нет победителей в раунде?

**Решение:** Раунд завершается без победителей, переходим к следующему
- Логируем событие
- Аукцион продолжается (возможно, это первый раунд и ставок ещё не было)

### 4. Поведение при ставке точно в момент завершения

**Решение:** Проверяем `endAt <= now` - если да, не принимаем ставку
- Аукцион уже завершён, ставка отклоняется
- Участник увидит ошибку "Auction has already ended"

## Edge cases

### 1. Пользователь делает ставку, затем увеличивает ставку

**Обработка:** Новая ставка заменяет старую
- Предыдущая ставка разблокируется
- Новая ставка блокируется
- Пользователь остаётся лидером с большей ставкой

### 2. Пользователь делает ставку меньше минимального шага

**Обработка:** Отклоняется до начала транзакции
- Быстрая проверка без блокировки
- Возвращается ошибка с минимальной требуемой суммой

### 3. Пользователь делает ставку на завершённый аукцион

**Обработка:** Отклоняется с ошибкой
- Проверка статуса в начале транзакции
- Аукцион уже в статусе 'finished'

### 4. Несколько раундов завершаются одновременно

**Обработка:** BullMQ обрабатывает параллельно (до 5 одновременно)
- Каждый аукцион имеет свою задачу
- Distributed lock предотвращает конфликты

### 5. Пользователь теряет соединение во время ставки

**Обработка:** Транзакция либо завершится, либо откатится
- Клиент не знает результат до переподключения
- Можно запросить статус через API

## Метрики успеха

### Финансовая корректность
- ✅ Все балансы сходятся: `balance + lockedBalance = сумма транзакций`
- ✅ Никакие средства не теряются
- ✅ Никакие средства не дублируются
- ✅ Все транзакции логируются

### Конкурентность
- ✅ Одновременные ставки обрабатываются корректно
- ✅ Нет двойных победителей
- ✅ Нет race conditions при перебитии ставок

### Производительность
- ✅ Ставка обрабатывается за < 500ms (P95)
- ✅ Система выдерживает 200+ concurrent users
- ✅ Нет деградации при нагрузке

### Надёжность
- ✅ Система восстанавливается после сбоев
- ✅ Транзакции откатываются при ошибках
- ✅ Фоновые задачи повторяются при сбоях

## Тестовые сценарии

### Сценарий 1: Базовый поток
1. Создать аукцион (3 раунда, 2 победителя на раунд)
2. 5 пользователей делают ставки
3. Раунд завершается, определяются 2 победителя
4. Следующий раунд начинается с 3 участниками
5. Повторяется для всех раундов

### Сценарий 2: Anti-sniping
1. Аукцион заканчивается через 10 секунд
2. Пользователь делает ставку за 5 секунд до конца
3. Аукцион продлевается на 30 секунд
4. Другой пользователь отвечает ставкой
5. Аукцион снова продлевается

### Сценарий 3: Конкурентные ставки
1. 10 пользователей одновременно делают ставки
2. Все ставки обрабатываются корректно
3. Определяется один победитель
4. Остальные получают возврат средств

### Сценарий 4: Нагрузка
1. 200 пользователей делают ставки на один аукцион
2. Система обрабатывает все запросы
3. Нет потери данных
4. Все балансы корректны

